# Loki Mode - 自主运行器

处理所有内容的单个脚本：先决条件、设置、Vibe Kanban 监控和带自动恢复的自主执行。

## 快速开始

```bash
# 使用 PRD 运行
./autonomy/run.sh ./docs/requirements.md

# 交互式运行
./autonomy/run.sh
```

就这样！脚本将会：
1. 检查所有先决条件（Claude CLI、Python、Git 等）
2. 验证技能安装
3. 初始化 `.loki/` 目录
4. **启动 Vibe Kanban 后台同步**（实时监控任务）
5. 启动带有**实时输出**的 Claude Code（不再盲目等待）
6. 在速率限制或中断时自动恢复
7. 持续运行直到完成或达到最大重试次数

## 实时输出

Claude 的输出实时显示 - 你可以准确地看到正在发生的事情：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  CLAUDE CODE OUTPUT (live)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Claude 的输出在这里实时显示...]
```

## 状态监视器（内置）

运行器每 5 秒更新一次 `.loki/STATUS.txt` 的任务进度：

```
╔════════════════════════════════════════════════════════════════╗
║                    LOKI MODE 状态                             ║
╚════════════════════════════════════════════════════════════════╝

更新时间：Sat Dec 28 15:30:00 PST 2025

阶段：开发

任务：
  ├─ 待处理：     10
  ├─ 进行中：    1
  ├─ 已完成：   5
  └─ 失败：      0

监控：watch -n 2 cat .loki/STATUS.txt
```

### 在另一个终端中监控

```bash
# 实时查看状态更新
watch -n 2 cat .loki/STATUS.txt

# 或查看一次
cat .loki/STATUS.txt
```

## 检查的内容

| 先决条件 | 必需 | 说明 |
|--------------|----------|-------|
| Claude Code CLI | 是 | 从 https://claude.ai/code 安装 |
| Python 3 | 是 | 用于状态管理 |
| Git | 是 | 用于版本控制 |
| curl | 是 | 用于 Web 获取 |
| Node.js | 否 | 某些构建需要 |
| jq | 否 | 有助于 JSON 解析 |

## 配置

环境变量：

```bash
# 重试设置
export LOKI_MAX_RETRIES=50      # 最大重试次数（默认：50）
export LOKI_BASE_WAIT=60        # 基础等待时间（秒）（默认：60）
export LOKI_MAX_WAIT=3600       # 最大等待时间（秒）（默认：3600）

# 跳过先决条件检查（用于 CI/CD 或重复运行）
export LOKI_SKIP_PREREQS=true

# 使用自定义设置运行
LOKI_MAX_RETRIES=100 LOKI_BASE_WAIT=120 ./autonomy/run.sh ./docs/prd.md
```

## 自动恢复工作原理

```
┌─────────────────────────────────────────────────────────────┐
│  ./autonomy/run.sh prd.md                                   │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  检查先决条件         │
              └───────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  初始化 .loki/        │
              └───────────────────────┘
                          │
                          ▼
         ┌────────────────────────────────┐
         │  使用提示运行 Claude Code      │◄────────────────┐
         └────────────────────────────────┘                 │
                          │                                 │
                          ▼                                 │
              ┌───────────────────────┐                     │
              │  Claude 退出          │                     │
              └───────────────────────┘                     │
                          │                                 │
              ┌───────────┴───────────┐                     │
              ▼                       ▼                     │
      ┌───────────────┐       ┌───────────────┐             │
      │  已完成？     │──是──│   成功！      │             │
      └───────────────┘       └───────────────┘             │
              │ 否                                          │
              ▼                                             │
      ┌───────────────┐                                     │
      │ 等待（退避）   │─────────────────────────────────────┘
      └───────────────┘
```

## 状态文件

自主运行器创建：

```
.loki/
├── autonomy-state.json    # 运行器状态（重试计数、状态）
├── logs/
│   └── autonomy-*.log     # 执行日志
├── state/
│   └── orchestrator.json  # Loki Mode 阶段跟踪
└── COMPLETED              # 完成时创建
```

## 中断后恢复

如果你停止脚本（Ctrl+C）或它崩溃了，只需再次运行：

```bash
# 状态已保存，将从上一个检查点恢复
./autonomy/run.sh ./docs/requirements.md
```

脚本检测到先前的状态并从中断处继续。

## 与手动模式的区别

| 功能 | 手动模式 | 自主模式 |
|---------|-------------|---------------|
| 启动 | `claude --dangerously-skip-permissions` | `./autonomy/run.sh` |
| 先决条件检查 | 手动 | 自动 |
| 速率限制处理 | 手动重启 | 自动恢复 |
| 状态持久化 | 手动检查点 | 自动 |
| 日志记录 | 仅控制台 | 控制台 + 文件 |
| 最大运行时间 | 基于会话 | 可配置重试 |

## 故障排除

### "未找到 Claude Code CLI"
```bash
npm install -g @anthropic-ai/claude-code
# 或访问 https://claude.ai/code
```

### "未找到 SKILL.md"
确保你从 loki-mode 目录运行或已安装技能：
```bash
# 选项 1：从项目目录运行
cd /path/to/claudeskill-loki-mode
./autonomy/run.sh

# 选项 2：全局安装技能
cp -r . ~/.claude/skills/loki-mode/
```

### "超过最大重试次数"
任务时间太长或反复失败。检查：
```bash
# 查看日志
cat .loki/logs/autonomy-*.log | tail -100

# 检查编排器状态
cat .loki/state/orchestrator.json

# 增加重试次数
LOKI_MAX_RETRIES=200 ./autonomy/run.sh ./docs/prd.md
```
